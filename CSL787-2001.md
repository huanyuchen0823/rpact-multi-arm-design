CSL 787-2001 Design
================
Huanyu Chen
2024-07-31

``` r
library(ggplot2)
library(rpact)
```

# Assumptions

In this clinical trial design, we assume an 80% power ($\beta = 0.2$)
and a one-sided significance level ($\alpha$) of 0.1. Subjects will be
followed for a maximum of 1 year, with the last subject being followed
for 0.5 years. The accrual time is 1.83 years, and the study duration is
2.33 years. The hazard rate ($\lambda$) for the placebo group is assumed
to be 1.2 per year. The hazard ratios are set at 0.6, 0.7, 0.8, and 0.9,
assuming an exponential distribution of events. The trial uses a 2:1
allocation ratio, meaning two subjects in the treatment group for every
one subject in the placebo group. This trial does not allow for early
stopping due to efficacy, ensuring that the study reaches its planned
conclusion unless futility is determined.

# Compare rpact results with EAST results

## EAST results

The table below shows the EAST results from Gaya. This is a fixed sample
design with 48 subjects per arm and a total of 78 events. The allocation
rate is 2:1 and other assumptions remain the same.

![](./EAST.png)

## rpact results

What I did for replicating the results:

1.  Since rpact did not have an output function for the rho parameter, I
    defined the beta spending at the interim analysis manually at the
    first step.
2.  Then I returned the results for the exit probability for futility at
    the interim analysis and compared with the highlighted values in the
    table. We can find that we will get the same values.

``` r
# rho = 1.07
design <- getDesignGroupSequential(kMax = 2, typeOfDesign = "noEarlyEfficacy",
                                   alpha = 0.1, typeBetaSpending = "bsUser",
                                   userBetaSpending = c(0.095, 0.199))

summary(getPowerSurvival(design, directionUpper = FALSE, lambda2 = 1.2,
                         hazardRatio = 0.6,
                         maxNumberOfEvents = 88, allocationRatioPlanned = 2,
                         accrualTime = c(0, 1.83), accrualIntensity = 87.9
                         )
        )
```

*Power calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, power directed
towards smaller values, H1: hazard ratio = 0.6, control lambda(2) = 1.2,
maximum number of events = 88, planned allocation ratio = 2, accrual
time = 1.83, accrual intensity = 87.9.

| Stage                                    | 1      | 2      |
|------------------------------------------|--------|--------|
| Planned information rate                 | 50%    | 100%   |
| Efficacy boundary (z-value scale)        | Inf    | 1.282  |
| Futility boundary (z-value scale)        | 0.285  |        |
| Cumulative power                         | 0      | 0.8018 |
| Number of subjects                       | 112.0  | 160.9  |
| Expected number of subjects under H1     | 156.2  |        |
| Expected number of events                | 83.8   |        |
| Cumulative number of events              | 44.0   | 88.0   |
| Analysis time                            | 1.27   | 1.96   |
| Expected study duration                  | 1.89   |        |
| Cumulative alpha spent                   | 0      | 0.1000 |
| Cumulative beta spent                    | 0.0950 | 0.1990 |
| One-sided local significance level       | 0      | 0.1000 |
| Efficacy boundary (t)                    | 0      | 0.748  |
| Futility boundary (t)                    | 0.913  |        |
| Overall exit probability (under H0)      | 0.6120 |        |
| Overall exit probability (under H1)      | 0.0946 |        |
| Exit probability for efficacy (under H0) | 0      |        |
| Exit probability for efficacy (under H1) | 0      |        |
| Exit probability for futility (under H0) | 0.6120 |        |
| Exit probability for futility (under H1) | 0.0946 |        |

Legend:

- *(t)*: treatment effect scale

## Conclusion

The results are the same. This gives us confidence to move forward with
rpact. I used the Beta Spending O’Brien & Fleming function (bsOF) for
later analysis in rpact because it is the internal function, but I am
open to other methods based on needs.

## Other code for reference

Final results are in .xlsx file attached.

### Allocation 2:1

``` r
# rho = 1.5
design <- getDesignGroupSequential(kMax = 2, typeOfDesign = "noEarlyEfficacy",
                                   alpha = 0.1, typeBetaSpending = "bsUser",
                                   userBetaSpending = c(0.070, 0.198))

summary(getPowerSurvival(design, directionUpper = FALSE, lambda2 = 1.2,
                         hazardRatio = 0.6,
                         maxNumberOfEvents = 81, allocationRatioPlanned = 2,
                         accrualTime = c(0, 1.83), accrualIntensity = 81.4))
```

*Power calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, power directed
towards smaller values, H1: hazard ratio = 0.6, control lambda(2) = 1.2,
maximum number of events = 81, planned allocation ratio = 2, accrual
time = 1.83, accrual intensity = 81.4.

| Stage                                    | 1      | 2      |
|------------------------------------------|--------|--------|
| Planned information rate                 | 50%    | 100%   |
| Efficacy boundary (z-value scale)        | Inf    | 1.282  |
| Futility boundary (z-value scale)        | 0.083  |        |
| Cumulative power                         | 0      | 0.7918 |
| Number of subjects                       | 103.3  | 149.0  |
| Expected number of subjects under H1     | 145.6  |        |
| Expected number of events                | 78.0   |        |
| Cumulative number of events              | 40.5   | 81.0   |
| Analysis time                            | 1.27   | 1.95   |
| Expected study duration                  | 1.90   |        |
| Cumulative alpha spent                   | 0      | 0.1000 |
| Cumulative beta spent                    | 0.0700 | 0.1980 |
| One-sided local significance level       | 0      | 0.1000 |
| Efficacy boundary (t)                    | 0      | 0.739  |
| Futility boundary (t)                    | 0.973  |        |
| Overall exit probability (under H0)      | 0.5331 |        |
| Overall exit probability (under H1)      | 0.0736 |        |
| Exit probability for efficacy (under H0) | 0      |        |
| Exit probability for efficacy (under H1) | 0      |        |
| Exit probability for futility (under H0) | 0.5331 |        |
| Exit probability for futility (under H1) | 0.0736 |        |

Legend:

- *(t)*: treatment effect scale

``` r
# rho = 2
design <- getDesignGroupSequential(kMax = 2, typeOfDesign = "noEarlyEfficacy",
                                   alpha = 0.1, typeBetaSpending = "bsUser",
                                   userBetaSpending = c(0.05, 0.2))

summary(getPowerSurvival(design, directionUpper = FALSE, lambda2 = 1.2,
                         hazardRatio = 0.6,
                         maxNumberOfEvents = 81, allocationRatioPlanned = 2,
                         accrualTime = c(0, 1.83), accrualIntensity = 81.4))
```

*Power calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, power directed
towards smaller values, H1: hazard ratio = 0.6, control lambda(2) = 1.2,
maximum number of events = 81, planned allocation ratio = 2, accrual
time = 1.83, accrual intensity = 81.4.

| Stage                                    | 1      | 2      |
|------------------------------------------|--------|--------|
| Planned information rate                 | 50%    | 100%   |
| Efficacy boundary (z-value scale)        | Inf    | 1.282  |
| Futility boundary (z-value scale)        | -0.115 |        |
| Cumulative power                         | 0      | 0.8010 |
| Number of subjects                       | 103.3  | 149.0  |
| Expected number of subjects under H1     | 146.7  |        |
| Expected number of events                | 79.0   |        |
| Cumulative number of events              | 40.5   | 81.0   |
| Analysis time                            | 1.27   | 1.95   |
| Expected study duration                  | 1.92   |        |
| Cumulative alpha spent                   | 0      | 0.1000 |
| Cumulative beta spent                    | 0.0500 | 0.2000 |
| One-sided local significance level       | 0      | 0.1000 |
| Efficacy boundary (t)                    | 0      | 0.739  |
| Futility boundary (t)                    | 1.039  |        |
| Overall exit probability (under H0)      | 0.4543 |        |
| Overall exit probability (under H1)      | 0.0497 |        |
| Exit probability for efficacy (under H0) | 0      |        |
| Exit probability for efficacy (under H1) | 0      |        |
| Exit probability for futility (under H0) | 0.4543 |        |
| Exit probability for futility (under H1) | 0.0497 |        |

Legend:

- *(t)*: treatment effect scale

``` r
# rho = 2.5
design <- getDesignGroupSequential(kMax = 2, typeOfDesign = "noEarlyEfficacy",
                                   alpha = 0.1, typeBetaSpending = "bsUser",
                                   userBetaSpending = c(0.035, 0.198))

summary(getPowerSurvival(design, directionUpper = FALSE, lambda2 = 1.2,
                         hazardRatio = 0.6,
                         maxNumberOfEvents = 80, allocationRatioPlanned = 2,
                         accrualTime = c(0, 1.83), accrualIntensity = 80.3))
```

*Power calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, power directed
towards smaller values, H1: hazard ratio = 0.6, control lambda(2) = 1.2,
maximum number of events = 80, planned allocation ratio = 2, accrual
time = 1.83, accrual intensity = 80.3.

| Stage                                    | 1      | 2      |
|------------------------------------------|--------|--------|
| Planned information rate                 | 50%    | 100%   |
| Efficacy boundary (z-value scale)        | Inf    | 1.282  |
| Futility boundary (z-value scale)        | -0.289 |        |
| Cumulative power                         | 0      | 0.8022 |
| Number of subjects                       | 102.0  | 146.9  |
| Expected number of subjects under H1     | 145.4  |        |
| Expected number of events                | 78.6   |        |
| Cumulative number of events              | 40.0   | 80.0   |
| Analysis time                            | 1.27   | 1.95   |
| Expected study duration                  | 1.93   |        |
| Cumulative alpha spent                   | 0      | 0.1000 |
| Cumulative beta spent                    | 0.0350 | 0.1980 |
| One-sided local significance level       | 0      | 0.1000 |
| Efficacy boundary (t)                    | 0      | 0.738  |
| Futility boundary (t)                    | 1.102  |        |
| Overall exit probability (under H0)      | 0.3861 |        |
| Overall exit probability (under H1)      | 0.0350 |        |
| Exit probability for efficacy (under H0) | 0      |        |
| Exit probability for efficacy (under H1) | 0      |        |
| Exit probability for futility (under H0) | 0.3861 |        |
| Exit probability for futility (under H1) | 0.0350 |        |

Legend:

- *(t)*: treatment effect scale

``` r
# rho = 1.5
design <- getDesignGroupSequential(typeOfDesign = "noEarlyEfficacy",
                                   alpha = 0.1, typeBetaSpending = "bsUser",
                                   userBetaSpending = c(0.050, 0.198),
                                   informationRates = c(0.4, 1)
                                   )

summary(getPowerSurvival(design, directionUpper = FALSE, lambda2 = 1.2,
                         hazardRatio = 0.6,
                         maxNumberOfEvents = 83, allocationRatioPlanned = 2,
                         accrualTime = c(0, 1.83), accrualIntensity = 83.1))
```

*Power calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, power directed
towards smaller values, H1: hazard ratio = 0.6, control lambda(2) = 1.2,
maximum number of events = 83, planned allocation ratio = 2, accrual
time = 1.83, accrual intensity = 83.1.

| Stage                                    | 1      | 2      |
|------------------------------------------|--------|--------|
| Planned information rate                 | 40%    | 100%   |
| Efficacy boundary (z-value scale)        | Inf    | 1.282  |
| Futility boundary (z-value scale)        | -0.261 |        |
| Cumulative power                         | 0      | 0.8036 |
| Number of subjects                       | 92.7   | 152.1  |
| Expected number of subjects under H1     | 149.1  |        |
| Expected number of events                | 80.5   |        |
| Cumulative number of events              | 33.2   | 83.0   |
| Analysis time                            | 1.12   | 1.96   |
| Expected study duration                  | 1.91   |        |
| Cumulative alpha spent                   | 0      | 0.1000 |
| Cumulative beta spent                    | 0.0500 | 0.1980 |
| One-sided local significance level       | 0      | 0.1000 |
| Efficacy boundary (t)                    | 0      | 0.742  |
| Futility boundary (t)                    | 1.101  |        |
| Overall exit probability (under H0)      | 0.3970 |        |
| Overall exit probability (under H1)      | 0.0496 |        |
| Exit probability for efficacy (under H0) | 0      |        |
| Exit probability for efficacy (under H1) | 0      |        |
| Exit probability for futility (under H0) | 0.3970 |        |
| Exit probability for futility (under H1) | 0.0496 |        |

Legend:

- *(t)*: treatment effect scale

### Allocation 1:1

``` r
# rho = 1
design <- getDesignGroupSequential(kMax = 2, typeOfDesign = "noEarlyEfficacy",
                                   alpha = 0.1, typeBetaSpending = "bsUser",
                                   userBetaSpending = c(0.1, 0.2))

summary(getPowerSurvival(design, directionUpper = FALSE, lambda2 = 1.2,
                         hazardRatio = 0.6,
                         maxNumberOfEvents = 79,
                         accrualTime = c(0, 1.83), accrualIntensity = 74.9))
```

*Power calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, power directed
towards smaller values, H1: hazard ratio = 0.6, control lambda(2) = 1.2,
maximum number of events = 79, accrual time = 1.83, accrual intensity =
74.9.

| Stage                                    | 1      | 2      |
|------------------------------------------|--------|--------|
| Planned information rate                 | 50%    | 100%   |
| Efficacy boundary (z-value scale)        | Inf    | 1.282  |
| Futility boundary (z-value scale)        | 0.320  |        |
| Cumulative power                         | 0      | 0.8015 |
| Number of subjects                       | 95.1   | 137.1  |
| Expected number of subjects under H1     | 132.9  |        |
| Expected number of events                | 75.1   |        |
| Cumulative number of events              | 39.5   | 79.0   |
| Analysis time                            | 1.27   | 1.97   |
| Expected study duration                  | 1.90   |        |
| Cumulative alpha spent                   | 0      | 0.1000 |
| Cumulative beta spent                    | 0.1000 | 0.2000 |
| One-sided local significance level       | 0      | 0.1000 |
| Efficacy boundary (t)                    | 0      | 0.749  |
| Futility boundary (t)                    | 0.903  |        |
| Overall exit probability (under H0)      | 0.6253 |        |
| Overall exit probability (under H1)      | 0.0993 |        |
| Exit probability for efficacy (under H0) | 0      |        |
| Exit probability for efficacy (under H1) | 0      |        |
| Exit probability for futility (under H0) | 0.6253 |        |
| Exit probability for futility (under H1) | 0.0993 |        |

Legend:

- *(t)*: treatment effect scale

``` r
# rho = 1.75
design <- getDesignGroupSequential(kMax = 2, typeOfDesign = "noEarlyEfficacy",
                                   alpha = 0.1, typeBetaSpending = "bsUser",
                                   userBetaSpending = c(0.059, 0.198))

summary(getPowerSurvival(design, directionUpper = FALSE, lambda2 = 1.2,
                         hazardRatio = 0.6,
                         maxNumberOfEvents = 73,
                         accrualTime = c(0, 1.83), accrualIntensity = 69.4))
```

*Power calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, power directed
towards smaller values, H1: hazard ratio = 0.6, control lambda(2) = 1.2,
maximum number of events = 73, accrual time = 1.83, accrual intensity =
69.4.

| Stage                                    | 1      | 2      |
|------------------------------------------|--------|--------|
| Planned information rate                 | 50%    | 100%   |
| Efficacy boundary (z-value scale)        | Inf    | 1.282  |
| Futility boundary (z-value scale)        | -0.018 |        |
| Cumulative power                         | 0      | 0.8012 |
| Number of subjects                       | 87.9   | 127.0  |
| Expected number of subjects under H1     | 124.7  |        |
| Expected number of events                | 70.8   |        |
| Cumulative number of events              | 36.5   | 73.0   |
| Analysis time                            | 1.27   | 1.96   |
| Expected study duration                  | 1.92   |        |
| Cumulative alpha spent                   | 0      | 0.1000 |
| Cumulative beta spent                    | 0.0590 | 0.1980 |
| One-sided local significance level       | 0      | 0.1000 |
| Efficacy boundary (t)                    | 0      | 0.741  |
| Futility boundary (t)                    | 1.006  |        |
| Overall exit probability (under H0)      | 0.4928 |        |
| Overall exit probability (under H1)      | 0.0593 |        |
| Exit probability for efficacy (under H0) | 0      |        |
| Exit probability for efficacy (under H1) | 0      |        |
| Exit probability for futility (under H0) | 0.4928 |        |
| Exit probability for futility (under H1) | 0.0593 |        |

Legend:

- *(t)*: treatment effect scale

``` r
# rho = 2.5
design <- getDesignGroupSequential(kMax = 2, typeOfDesign = "noEarlyEfficacy",
                                   alpha = 0.1, typeBetaSpending = "bsUser",
                                   userBetaSpending = c(0.035, 0.198))

summary(getPowerSurvival(design, directionUpper = FALSE, lambda2 = 1.2,
                         hazardRatio = 0.6,
                         maxNumberOfEvents = 71,
                         accrualTime = c(0, 1.83), accrualIntensity = 67.2))
```

*Power calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, power directed
towards smaller values, H1: hazard ratio = 0.6, control lambda(2) = 1.2,
maximum number of events = 71, accrual time = 1.83, accrual intensity =
67.2.

| Stage                                    | 1      | 2      |
|------------------------------------------|--------|--------|
| Planned information rate                 | 50%    | 100%   |
| Efficacy boundary (z-value scale)        | Inf    | 1.282  |
| Futility boundary (z-value scale)        | -0.289 |        |
| Cumulative power                         | 0      | 0.8018 |
| Number of subjects                       | 85.4   | 123.0  |
| Expected number of subjects under H1     | 121.7  |        |
| Expected number of events                | 69.8   |        |
| Cumulative number of events              | 35.5   | 71.0   |
| Analysis time                            | 1.27   | 1.97   |
| Expected study duration                  | 1.94   |        |
| Cumulative alpha spent                   | 0      | 0.1000 |
| Cumulative beta spent                    | 0.0350 | 0.1980 |
| One-sided local significance level       | 0      | 0.1000 |
| Efficacy boundary (t)                    | 0      | 0.738  |
| Futility boundary (t)                    | 1.102  |        |
| Overall exit probability (under H0)      | 0.3861 |        |
| Overall exit probability (under H1)      | 0.0350 |        |
| Exit probability for efficacy (under H0) | 0      |        |
| Exit probability for efficacy (under H1) | 0      |        |
| Exit probability for futility (under H0) | 0.3861 |        |
| Exit probability for futility (under H1) | 0.0350 |        |

Legend:

- *(t)*: treatment effect scale

``` r
# rho = 1
design <- getDesignGroupSequential(typeOfDesign = "noEarlyEfficacy",
                                   alpha = 0.1, typeBetaSpending = "bsUser",
                                   userBetaSpending = c(0.08, 0.2),
                                   informationRates = c(0.4, 1)
                                   )

summary(getPowerSurvival(design, directionUpper = FALSE, lambda2 = 1.2,
                         hazardRatio = 0.6,
                         maxNumberOfEvents = 78,
                         accrualTime = c(0, 1.83), accrualIntensity = 74.3))
```

*Power calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, power directed
towards smaller values, H1: hazard ratio = 0.6, control lambda(2) = 1.2,
maximum number of events = 78, accrual time = 1.83, accrual intensity =
74.3.

| Stage                                    | 1      | 2      |
|------------------------------------------|--------|--------|
| Planned information rate                 | 40%    | 100%   |
| Efficacy boundary (z-value scale)        | Inf    | 1.282  |
| Futility boundary (z-value scale)        | 0.014  |        |
| Cumulative power                         | 0      | 0.8033 |
| Number of subjects                       | 82.3   | 136.0  |
| Expected number of subjects under H1     | 131.7  |        |
| Expected number of events                | 74.3   |        |
| Cumulative number of events              | 31.2   | 78.0   |
| Analysis time                            | 1.11   | 1.96   |
| Expected study duration                  | 1.89   |        |
| Cumulative alpha spent                   | 0      | 0.1000 |
| Cumulative beta spent                    | 0.0800 | 0.2000 |
| One-sided local significance level       | 0      | 0.1000 |
| Efficacy boundary (t)                    | 0      | 0.748  |
| Futility boundary (t)                    | 0.995  |        |
| Overall exit probability (under H0)      | 0.5055 |        |
| Overall exit probability (under H1)      | 0.0788 |        |
| Exit probability for efficacy (under H0) | 0      |        |
| Exit probability for efficacy (under H1) | 0      |        |
| Exit probability for futility (under H0) | 0.5055 |        |
| Exit probability for futility (under H1) | 0.0788 |        |

Legend:

- *(t)*: treatment effect scale

# Task

1.  Given an 80% power ($\beta$) and a one-sided significance level
    ($\alpha$) of 0.1, calculate the sample size needed to achieve this
    goal for a hazard ratio (HR) of 0.6.

2.  Replicate the power based on a fixed sample size derived in step 1
    to check the accuracy of the calculation.

3.  Generalize the results to different hazard ratios of 0.6, 0.7, 0.8,
    and 0.9.

    1.  Given an 80% power ($\beta$) and a one-sided significance level
        ($\alpha$) of 0.1, calculate the sample size needed to achieve
        this goal for different hazard ratios.

    2.  Calculate the power based on the sample size for HR = 0.6 to
        check how different hazard ratios influence the probability.

# Design

## Code and Output

``` r
design <- getDesignGroupSequential(kMax = 2, typeOfDesign = "noEarlyEfficacy",
                                   alpha = 0.1, typeBetaSpending = "bsOF")
summary(design)
```

*Sequential analysis with a maximum of 2 looks (group sequential
design)*

No early efficacy stop design, non-binding futility, one-sided overall
significance level 10%, power 80%, undefined endpoint, inflation factor
1.0695, ASN H1 1.0321, ASN H01 0.9401, ASN H0 0.7859.

| Stage                             | 1      | 2      |
|-----------------------------------|--------|--------|
| Planned information rate          | 50%    | 100%   |
| Efficacy boundary (z-value scale) | Inf    | 1.282  |
| Stage levels (one-sided)          | 0      | 0.1000 |
| Futility boundary (z-value scale) | 0.076  |        |
| Cumulative alpha spent            | 0      | 0.1000 |
| Cumulative beta spent             | 0.0699 | 0.2000 |
| Cumulative power                  | 0      | 0.8000 |
| Futility probabilities under H1   | 0.070  |        |

## Results and Interpretation

`Futility probabilities under H1` = `Cumulative beta spent` = 0.0699

This design includes an O’Brien & Fleming beta spending approach, where
the probability of stopping for futility is controlled and accumulates
across stages.

# HR = 0.6

## Introduction

My goal in this section will focus on two things:

1.  Defining a fixed power and calculating the sample size.

2.  Calculating power based on a fixed sample size.

We can further find in this section that the sample size corresponds to
the power, i.e., the sample size calculated after the power is
determined in the first step can get the same power in the second step.

## Sample Size

### Code and Output

``` r
accrualTime = c(0, 1.83)
studyDuration = 2.33

summary(getSampleSizeSurvival(design, lambda2 = 1.2, hazardRatio = 0.6,
                              allocationRatioPlanned = 2, accrualTime = c(0, 1.83),
                              followUpTime = min(studyDuration - max(accrualTime), 1)
                              )
        )
```

*Sample size calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, H1: hazard ratio =
0.6, control lambda(2) = 1.2, planned allocation ratio = 2, accrual time
= 1.83, accrual intensity = 68.1, follow-up time = 0.5, power 80%.

| Stage                                    | 1      | 2      |
|------------------------------------------|--------|--------|
| Planned information rate                 | 50%    | 100%   |
| Efficacy boundary (z-value scale)        | Inf    | 1.282  |
| Futility boundary (z-value scale)        | 0.076  |        |
| Cumulative power                         | 0      | 0.8000 |
| Number of subjects                       | 97.7   | 124.6  |
| Expected number of subjects under H1     | 122.7  |        |
| Cumulative number of events              | 41.6   | 83.1   |
| Analysis time                            | 1.44   | 2.33   |
| Expected study duration                  | 2.27   |        |
| Cumulative alpha spent                   | 0      | 0.1000 |
| Cumulative beta spent                    | 0.0699 | 0.2000 |
| One-sided local significance level       | 0      | 0.1000 |
| Efficacy boundary (t)                    | 0      | 0.742  |
| Futility boundary (t)                    | 0.975  |        |
| Overall exit probability (under H0)      | 0.5304 |        |
| Overall exit probability (under H1)      | 0.0699 |        |
| Exit probability for efficacy (under H0) | 0      |        |
| Exit probability for efficacy (under H1) | 0      |        |
| Exit probability for futility (under H0) | 0.5304 |        |
| Exit probability for futility (under H1) | 0.0699 |        |

Legend:

- *(t)*: treatment effect scale

### Results and Interpretation

The calculation indicates that for an 80% power and a one-sided
significance level of 0.1, the sample sizes required are 97.7 subjects
in the first stage and 124.6 subjects in the second stage. The
cumulative number of events expected is 83.1. The overall exit
probability for futility under the null hypothesis ($H_0$) is 53.04%,
and under the alternative hypothesis ($H_1$), it is 6.99%. The expected
study duration is approximately 2.27 years. This design ensures that the
study will have sufficient power to detect the specified hazard ratio
with the given parameters.

## Power

### Assumptions and Code Explanations

`directionUpper = FALSE` indicates that the incidence of treatment arm
is lower than placebo.

`typeOfComputation = "Schoenfeld"` shows that it is based on the
proportional hazards model and provides log-rank tests to compare the
survival curves.

`kappa = 1` stands for the exponential survival distribution.

`maxNumberOfEvents` uses the data 83.1 calculated in the previous sample
size section.

`accrualIntensity` is calculated as: max Number Of Subjects / accrual
time. In this example, I am using the data calculated in the previous
sample size section, which is 124.6/1.83 = 68.09.

Both codes will give exactly the same result. The only difference in the
code is `accrualIntensity = 68.09` and `maxNumberOfSubjects = 124.6`,
but as we said, they mean the same thing and can be converted to each
other.

### Code and Output

``` r
summary(getPowerSurvival(design, thetaH0 = 1, typeOfComputation = "Schoenfeld",
                         directionUpper = FALSE, lambda2 = 1.2, hazardRatio = 0.6,
                         maxNumberOfSubjects = 124.6, maxNumberOfEvents = 83.1,
                         allocationRatioPlanned = 2, accrualTime = c(0, 1.83), kappa = 1))
```

``` r
summary(getPowerSurvival(design, thetaH0 = 1, typeOfComputation = "Schoenfeld",
                         directionUpper = FALSE, lambda2 = 1.2, hazardRatio = 0.6,
                         maxNumberOfEvents = 83.1, allocationRatioPlanned = 2,
                         accrualTime = c(0, 1.83), accrualIntensity = 68.09, kappa = 1))
```

*Power calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, power directed
towards smaller values, H1: hazard ratio = 0.6, control lambda(2) = 1.2,
maximum number of events = 84, planned allocation ratio = 2, accrual
time = 1.83, accrual intensity = 68.1.

| Stage                                    | 1      | 2      |
|------------------------------------------|--------|--------|
| Planned information rate                 | 50%    | 100%   |
| Efficacy boundary (z-value scale)        | Inf    | 1.282  |
| Futility boundary (z-value scale)        | 0.076  |        |
| Cumulative power                         | 0      | 0.7998 |
| Number of subjects                       | 97.7   | 124.6  |
| Expected number of subjects under H1     | 122.7  |        |
| Expected number of events                | 80.2   |        |
| Cumulative number of events              | 41.5   | 83.1   |
| Analysis time                            | 1.43   | 2.33   |
| Expected study duration                  | 2.27   |        |
| Cumulative alpha spent                   | 0      | 0.1000 |
| Cumulative beta spent                    | 0.0699 | 0.2000 |
| One-sided local significance level       | 0      | 0.1000 |
| Efficacy boundary (t)                    | 0      | 0.742  |
| Futility boundary (t)                    | 0.975  |        |
| Overall exit probability (under H0)      | 0.5304 |        |
| Overall exit probability (under H1)      | 0.0700 |        |
| Exit probability for efficacy (under H0) | 0      |        |
| Exit probability for efficacy (under H1) | 0      |        |
| Exit probability for futility (under H0) | 0.5304 |        |
| Exit probability for futility (under H1) | 0.0700 |        |

Legend:

- *(t)*: treatment effect scale

### Results and Interpretation

`Exit probability for futility (under H0)` = 0.5304 and
`Exit probability for futility (under H1)` = 0.0700.

This design allows for early stopping due to futility, with a 53.04%
probability of stopping if the null hypothesis is true (no treatment
effect) and a 7% probability if the alternative hypothesis is true
(treatment effect).

## Conclusion

In this section, our results successfully conclude that sample size
corresponds to power.

Specifically,

`Number of subjects` = 124.6 and `Cumulative number of events` = 83.1

corresponds to

`Exit probability for futility (under H0)` = 0.5304 and
`Exit probability for futility (under H1)` = 0.0700.

## Next Step:

I am now trying to generalize the case of HR = 0.6 to different HRs.

The ideas are still broken down into two parts:

1.  Given the power (derived from alpha/beta), we can get different
    sample sizes for different HRs.

2.  Given the sample size (which I based on the HR = 0.6 case while
    referring to Gaya’s calculations in EAST, but this is open to
    discussion), calculate power for the case of different HRs.

Only the HRs in the code are changed.

# Combine Different HRs

## Sample Size

### Code and Output

``` r
summary(getSampleSizeSurvival(design, lambda2 = 1.2, hazardRatio = c(0.6, 0.7, 0.8, 0.9),
                              allocationRatioPlanned = 2, accrualTime = c(0, 1.83),
                              followUpTime = min(studyDuration - max(accrualTime), 1)))
```

*Sample size calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, H1: hazard ratio as
specified, control lambda(2) = 1.2, planned allocation ratio = 2,
accrual time = 1.83, follow-up time = 0.5, power 80%.

| Stage                                          | 1      | 2      |
|------------------------------------------------|--------|--------|
| Planned information rate                       | 50%    | 100%   |
| Efficacy boundary (z-value scale)              | Inf    | 1.282  |
| Futility boundary (z-value scale)              | 0.076  |        |
| Cumulative power                               | 0      | 0.8000 |
| Number of subjects, HR = 0.6                   | 97.7   | 124.6  |
| Number of subjects, HR = 0.7                   | 188.9  | 242.8  |
| Number of subjects, HR = 0.8                   | 459.3  | 595.5  |
| Number of subjects, HR = 0.9                   | 1975.2 | 2583.0 |
| Expected number of subjects under H1, HR = 0.6 | 122.7  |        |
| Expected number of subjects under H1, HR = 0.7 | 239.1  |        |
| Expected number of subjects under H1, HR = 0.8 | 586.0  |        |
| Expected number of subjects under H1, HR = 0.9 | 2540.5 |        |
| Cumulative number of events, HR = 0.6          | 41.6   | 83.1   |
| Cumulative number of events, HR = 0.7          | 85.3   | 170.5  |
| Cumulative number of events, HR = 0.8          | 217.9  | 435.7  |
| Cumulative number of events, HR = 0.9          | 977.2  | 1954.4 |
| Analysis time, HR = 0.6                        | 1.44   | 2.33   |
| Analysis time, HR = 0.7                        | 1.42   | 2.33   |
| Analysis time, HR = 0.8                        | 1.41   | 2.33   |
| Analysis time, HR = 0.9                        | 1.40   | 2.33   |
| Expected study duration, HR = 0.6              | 2.27   |        |
| Expected study duration, HR = 0.7              | 2.27   |        |
| Expected study duration, HR = 0.8              | 2.27   |        |
| Expected study duration, HR = 0.9              | 2.26   |        |
| Cumulative alpha spent                         | 0      | 0.1000 |
| Cumulative beta spent                          | 0.0699 | 0.2000 |
| One-sided local significance level             | 0      | 0.1000 |
| Efficacy boundary (t), HR = 0.6                | 0      | 0.742  |
| Efficacy boundary (t), HR = 0.7                | 0      | 0.812  |
| Efficacy boundary (t), HR = 0.8                | 0      | 0.878  |
| Efficacy boundary (t), HR = 0.9                | 0      | 0.940  |
| Futility boundary (t), HR = 0.6                | 0.975  |        |
| Futility boundary (t), HR = 0.7                | 0.983  |        |
| Futility boundary (t), HR = 0.8                | 0.989  |        |
| Futility boundary (t), HR = 0.9                | 0.995  |        |
| Overall exit probability (under H0)            | 0.5304 |        |
| Overall exit probability (under H1)            | 0.0699 |        |
| Exit probability for efficacy (under H0)       | 0      |        |
| Exit probability for efficacy (under H1)       | 0      |        |
| Exit probability for futility (under H0)       | 0.5304 |        |
| Exit probability for futility (under H1)       | 0.0699 |        |

Legend:

- *HR*: hazard ratio
- *(t)*: treatment effect scale

### Results and Interpretation

Can focus on: `Number of subjects` and `Cumulative number of events`.

The sample size and number of events required for the trial increase
significantly as the HR approaches 1. This is because detecting smaller
differences between groups requires a larger sample size and more events
to achieve the desired statistical power (80%). For instance, to detect
an HR of 0.6, only 124.6 subjects and 83.1 events are needed. However,
for an HR of 0.9, the trial would require 2583.0 subjects and 1954.4
events. This reflects the increased difficulty in detecting smaller
differences and the need for more data to draw reliable conclusions.

Below is a sample output table that summarizes the important output:

| Hazard Ratio (HR) | Number of Subjects (Stage 1) | Number of Subjects (Stage 2) | Cumulative Number of Events (Stage 1) | Cumulative Number of Events (Stage 2) |
|-------------------|------------------------------|------------------------------|---------------------------------------|---------------------------------------|
| 0.6               | 97.7                         | 124.6                        | 41.6                                  | 83.1                                  |
| 0.7               | 188.9                        | 242.8                        | 85.3                                  | 170.5                                 |
| 0.8               | 459.3                        | 595.5                        | 217.9                                 | 435.7                                 |
| 0.9               | 1975.2                       | 2583.0                       | 977.2                                 | 1954.4                                |

## Power

### Code and Output

``` r
summary(getPowerSurvival(design, thetaH0 = 1, typeOfComputation = "Schoenfeld",
                         directionUpper = FALSE, lambda2 = 1.2,
                         hazardRatio = c(0.6, 0.7, 0.8, 0.9),
                         maxNumberOfSubjects = 124.6, maxNumberOfEvents = 83.1,
                         allocationRatioPlanned = 2, accrualTime = c(0, 1.83), kappa = 1))
```

``` r
summary(getPowerSurvival(design, thetaH0 = 1, typeOfComputation = "Schoenfeld",
                         directionUpper = FALSE, lambda2 = 1.2,
                         hazardRatio = c(0.6, 0.7, 0.8, 0.9),
                         maxNumberOfEvents = 83.1, allocationRatioPlanned = 2,
                         accrualTime = c(0, 1.83), accrualIntensity = 68.09, kappa = 1))
```

*Power calculation for a survival endpoint*

Sequential analysis with a maximum of 2 looks (group sequential design),
overall significance level 10% (one-sided). The results were calculated
for a two-sample logrank test, H0: hazard ratio = 1, power directed
towards smaller values, H1: hazard ratio as specified, control lambda(2)
= 1.2, maximum number of events = 84, planned allocation ratio = 2,
accrual time = 1.83, accrual intensity = 68.1.

| Stage                                              | 1      | 2      |
|----------------------------------------------------|--------|--------|
| Planned information rate                           | 50%    | 100%   |
| Efficacy boundary (z-value scale)                  | Inf    | 1.282  |
| Futility boundary (z-value scale)                  | 0.076  |        |
| Cumulative power, HR = 0.6                         | 0      | 0.7998 |
| Cumulative power, HR = 0.7                         | 0      | 0.5772 |
| Cumulative power, HR = 0.8                         | 0      | 0.3559 |
| Cumulative power, HR = 0.9                         | 0      | 0.1924 |
| Number of subjects, HR = 0.6                       | 97.7   | 124.6  |
| Number of subjects, HR = 0.7                       | 93.9   | 124.6  |
| Number of subjects, HR = 0.8                       | 90.8   | 124.6  |
| Number of subjects, HR = 0.9                       | 88.1   | 124.6  |
| Expected number of subjects under H1, HR = 0.6     | 122.7  |        |
| Expected number of subjects under H1, HR = 0.7     | 119.8  |        |
| Expected number of subjects under H1, HR = 0.8     | 115.3  |        |
| Expected number of subjects under H1, HR = 0.9     | 109.9  |        |
| Expected number of events, HR = 0.6                | 80.2   |        |
| Expected number of events, HR = 0.7                | 76.6   |        |
| Expected number of events, HR = 0.8                | 71.7   |        |
| Expected number of events, HR = 0.9                | 66.3   |        |
| Cumulative number of events                        | 41.5   | 83.1   |
| Analysis time, HR = 0.6                            | 1.43   | 2.33   |
| Analysis time, HR = 0.7                            | 1.38   | 2.21   |
| Analysis time, HR = 0.8                            | 1.33   | 2.12   |
| Analysis time, HR = 0.9                            | 1.29   | 2.05   |
| Expected study duration, HR = 0.6                  | 2.27   |        |
| Expected study duration, HR = 0.7                  | 2.08   |        |
| Expected study duration, HR = 0.8                  | 1.90   |        |
| Expected study duration, HR = 0.9                  | 1.74   |        |
| Cumulative alpha spent                             | 0      | 0.1000 |
| Cumulative beta spent                              | 0.0699 | 0.2000 |
| One-sided local significance level                 | 0      | 0.1000 |
| Efficacy boundary (t)                              | 0      | 0.742  |
| Futility boundary (t)                              | 0.975  |        |
| Overall exit probability (under H0)                | 0.5304 |        |
| Overall exit probability (under H1)                | 0.0700 |        |
| Exit probability for efficacy (under H0)           | 0      |        |
| Exit probability for efficacy (under H1), HR = 0.6 | 0      |        |
| Exit probability for efficacy (under H1), HR = 0.7 | 0      |        |
| Exit probability for efficacy (under H1), HR = 0.8 | 0      |        |
| Exit probability for efficacy (under H1), HR = 0.9 | 0      |        |
| Exit probability for futility (under H0)           | 0.5304 |        |
| Exit probability for futility (under H1), HR = 0.6 | 0.0700 |        |
| Exit probability for futility (under H1), HR = 0.7 | 0.1568 |        |
| Exit probability for futility (under H1), HR = 0.8 | 0.2737 |        |
| Exit probability for futility (under H1), HR = 0.9 | 0.4037 |        |

Legend:

- *HR*: hazard ratio
- *(t)*: treatment effect scale

### Results and Interpretation

- **Exit probability for futility (under H1) given the overall sample
  size = 124.6:**

  - HR = 0.6: 7.00% probability of stopping early for futility (under
    H1).

  - HR = 0.7: 15.68% probability of stopping early for futility (under
    H1).

  - HR = 0.8: 27.37% probability of stopping early for futility (under
    H1).

  - HR = 0.9: 40.37% probability of stopping early for futility (under
    H1).

- **Expected number of subjects under H1:**

  - Expected number of subjects under H1 decreases from 122.7 (HR = 0.6)
    to 109.9 (HR = 0.9).

  - The expected number of subjects decreases with increasing HR values,
    indicating a higher likelihood of early stopping as the treatment
    effect diminishes.

Below is a sample output table that summarizes the important output:

| HR  | Exit Probability for Efficacy Stage 1 | Exit Probability for Futility Stage 1 | Number of Subjects Stage 1 | Number of Subjects Stage 2 | Expected Number of Subjects |
|-----|---------------------------------------|---------------------------------------|----------------------------|----------------------------|-----------------------------|
| 0.6 | 0                                     | 0.0700                                | 97.7                       | 124.6                      | 122.7                       |
| 0.7 | 0                                     | 0.1568                                | 93.9                       | 124.6                      | 119.8                       |
| 0.8 | 0                                     | 0.2737                                | 90.8                       | 124.6                      | 115.3                       |
| 0.9 | 0                                     | 0.4037                                | 88.1                       | 124.6                      | 109.9                       |

# Multi-Arm GSD (both arms)

## Assumption

In this fixed sample size design, we ensure an overall one-sided
significance level of 0.1 (alpha = 0.1) and a power of 80% (beta = 0.2).
This design was configured to avoid early efficacy stopping and utilized
**O’Brien & Fleming beta spending function** approach. We assumed hazard
ratios of 0.6 and 0.7 for the high dose and low dose treatment arms. The
study planned for 45 events in the first stage and 90 cumulative events
by the second stage, with an allocation ratio of 1:1 for two arms.

## Code and Output

``` r
design <- getDesignInverseNormal(
  kMax = 2, 
  alpha = 0.1,
  beta = 0.2,
  typeOfDesign = "noEarlyEfficacy",
  typeBetaSpending = "bsUser",
  userBetaSpending = c(0.059, 0.198) # rho = 1.75
  )

hazardRatios <- c(0.6, 0.7)
plannedEvents <- c(45, 90)

simulationResults <- getSimulationMultiArmSurvival(
  design = design,
  activeArms = 2,
  effectMatrix = matrix(hazardRatios, ncol = 2, byrow = TRUE),
  typeOfShape = "userDefined", # effect matrix
  intersectionTest = "Hierarchical",
  directionUpper = FALSE,
  typeOfSelection = "all",
  plannedEvents = plannedEvents,
  allocationRatioPlanned = 1,
  minNumberOfEventsPerStage = c(NA_real_, 40),
  maxNumberOfEventsPerStage = c(NA_real_, 60),
  conditionalPower = 0.8,
  maxNumberOfIterations = 5000,
  seed = 12345
)

summary(simulationResults)
```

*Simulation of a survival endpoint (multi-arm design)*

Sequential analysis with a maximum of 2 looks (inverse normal
combination test design), overall significance level 10% (one-sided).
The results were simulated for a multi-arm logrank test (2 treatments
vs. control), H0: hazard ratio(i) = 1, power directed towards smaller
values, H1: omega_max = 0.7, planned cumulative events = c(45, 90),
effect shape = user defined, intersection test = Hierarchical, selection
= all, effect measure based on effect estimate, success criterion: all,
sample size reassessment: conditional power = 0.8, minimum events per
stage = c(45, 40), maximum events per stage = c(45, 60), simulation runs
= 5000, seed = 12345.

| Stage                              | 1      | 2      |
|------------------------------------|--------|--------|
| Fixed weight                       | 0.707  | 0.707  |
| Efficacy boundary (z-value scale)  | Inf    | 1.282  |
| Stage levels (one-sided)           | 0      | 0.1000 |
| Futility boundary (z-value scale)  | -0.018 |        |
| Reject at least one                | 0.7750 |        |
| Rejected arms per stage            |        |        |
| Treatment arm vs. control          | 0      | 0.7750 |
| Treatment arm vs. control          | 0      | 0.4964 |
| Success per stage                  | 0      | 0.4964 |
| Exit probability for futility      | 0.0768 |        |
| Expected number of events under H1 | 91.9   |        |
| Overall exit probability           | 0.0768 |        |
| Cumulative number of events        |        |        |
| Treatment arm vs. control          | 31.3   | 66.6   |
| Treatment arm vs. control          | 33.3   | 70.8   |
| Selected arms                      |        |        |
| Treatment arm vs. control          | 1.0000 | 0.9232 |
| Treatment arm vs. control          | 1.0000 | 0.9232 |
| Number of active arms              | 2.000  | 2.000  |
| Conditional power (achieved)       |        | 0.7968 |

Legend:

- *(i)*: treatment arm i

## Results and Interpretation

- Probability of rejecting each treatment group in stage 2:

  - High dose vs. control: 76.84%

  - Low dose vs. control: 49.30%

- Exit probability for futility: 9.4%

- Conditional power: 80.49%

We can find that the probability of rejecting at least one hypothesis in
the second stage is 76.84%. Moreover, overall exit probability is 9.40%.

# Multi-Arm GSD (best arm)

## Introduction

In this section, we wish to select the best arm for the second stage of
the analysis. This means that we will drop an arm in the interim
analysis. We can do this by defining `typeOfSelection = "best"` in the
function `getSimulationMultiArmSurvival`.

## Assumption

As mentioned in the previous section, this fixed sample size design can
ensure an overall one-sided significance level of 0.1 (alpha = 0.1) and
a power of 80% (beta = 0.2). Additionally, this design was configured to
avoid early efficacy stopping and utilized **O’Brien & Fleming beta
spending function** approach. We assumed hazard ratios of 0.6 and 0.7
for the high dose and low dose treatment arms. The study planned for 45
events in the first stage and 90 cumulative events by the second stage,
with an allocation ratio of 1:1 for two arms.

## Code and Output

``` r
design <- getDesignInverseNormal(
  kMax = 2, 
  alpha = 0.1,
  beta = 0.2,
  typeOfDesign = "noEarlyEfficacy",
  typeBetaSpending = "bsUser",
  userBetaSpending = c(0.059, 0.198) # rho = 1.75
  )

hazardRatios <- c(0.6, 0.7)
effectMatrix <- matrix(hazardRatios, ncol = 2, byrow = TRUE)
plannedEvents <- c(45, 90)

simulationResults <- getSimulationMultiArmSurvival(
  design = design,
  activeArms = 2,
  effectMatrix = effectMatrix,
  typeOfShape = "userDefined", # effect matrix
  intersectionTest = "Hierarchical",
  # intersectionTest = "Dunnett",
  directionUpper = FALSE,
  typeOfSelection = "best",
  plannedEvents = plannedEvents,
  allocationRatioPlanned = 1,
  minNumberOfEventsPerStage = c(NA_real_, 40),
  maxNumberOfEventsPerStage = c(NA_real_, 60),
  conditionalPower = 0.8,
  maxNumberOfIterations = 5000,
  seed = 12345
)

summary(simulationResults)
```

*Simulation of a survival endpoint (multi-arm design)*

Sequential analysis with a maximum of 2 looks (inverse normal
combination test design), overall significance level 10% (one-sided).
The results were simulated for a multi-arm logrank test (2 treatments
vs. control), H0: hazard ratio(i) = 1, power directed towards smaller
values, H1: omega_max = 0.7, planned cumulative events = c(45, 90),
effect shape = user defined, intersection test = Hierarchical, selection
= best, effect measure based on effect estimate, success criterion: all,
sample size reassessment: conditional power = 0.8, minimum events per
stage = c(45, 40), maximum events per stage = c(45, 60), simulation runs
= 5000, seed = 12345.

| Stage                              | 1      | 2      |
|------------------------------------|--------|--------|
| Fixed weight                       | 0.707  | 0.707  |
| Efficacy boundary (z-value scale)  | Inf    | 1.282  |
| Stage levels (one-sided)           | 0      | 0.1000 |
| Futility boundary (z-value scale)  | -0.018 |        |
| Reject at least one                | 0.5892 |        |
| Rejected arms per stage            |        |        |
| Treatment arm vs. control          | 0      | 0.5892 |
| Treatment arm vs. control          | 0      | 0      |
| Success per stage                  | 0      | 0.5892 |
| Exit probability for futility      | 0.0748 |        |
| Expected number of events under H1 | 87.8   |        |
| Overall exit probability           | 0.0748 |        |
| Cumulative number of events        |        |        |
| Treatment arm vs. control          | 31.3   | 71.7   |
| Treatment arm vs. control          | 33.3   | 67.5   |
| Selected arms                      |        |        |
| Treatment arm vs. control          | 1.0000 | 0.6386 |
| Treatment arm vs. control          | 1.0000 | 0.2866 |
| Number of active arms              | 2.000  | 1.000  |
| Conditional power (achieved)       |        | 0.7978 |

Legend:

- *(i)*: treatment arm i

## Results and Interpretation

- In stage 1, no efficacy boundaries were used, which is consistent with
  our hypothesis. In stage 2, the probability of the trial rejecting at
  least one hypothesis was 58.72%, as was the success rate.

- The exit probability for futility at interim analysis was 8.74%.

- Higher doses are more likely to be selected (with a probability of
  63.5%) compared to lower doses (with a probability of 63.5%), so
  higher doses will be preferred in stage 2 as the “best” dose.

- The conditional power achieved in the second phase was 80.32%, which
  is close to the target value of 80%.

# Question:

- If we chose `intersectionTest = "Dunnett"`, we can get following
  results:
  - Rejected arms per stage
  - Treatment arm vs. control 0 0.5418
  - Treatment arm vs. control 0 0.2412
- However, if we chose `intersectionTest = "Hierarchical"`, we can get
  following results:
  - Rejected arms per stage
  - Treatment arm vs. control 0 0.5872
  - Treatment arm vs. control 0 0
- The second treatment arm in hierarchical testing will get zero at the
  second stage no matter the value of parameters. I am not very sure why
  it happened? How to understand it and interpret the results? Is my
  current understanding correct:
  - If the first treatment arm rejects null, we stop and conclude that
    at least one treatment arm is valid. If the first treatment group
    fails to reject null, then the second treatment group cannot reject
    null either. In this way, the final result will be 0.

## intersectionTest = “Dunnett” & hazardRatios \<- c(0.6, 0.7)

``` r
design <- getDesignInverseNormal(
  kMax = 2, 
  alpha = 0.1,
  beta = 0.2,
  typeOfDesign = "noEarlyEfficacy",
  typeBetaSpending = "bsOF"
)

hazardRatios <- c(0.6, 0.7)
effectMatrix <- matrix(hazardRatios, ncol = 2, byrow = TRUE)
plannedEvents <- c(45, 90)

simulationResults <- getSimulationMultiArmSurvival(
  design = design,
  activeArms = 2,
  effectMatrix = effectMatrix,
  typeOfShape = "userDefined",
  intersectionTest = "Dunnett",
  directionUpper = FALSE,
  typeOfSelection = "best",
  plannedEvents = plannedEvents,
  allocationRatioPlanned = 1,
  minNumberOfEventsPerStage = c(NA_real_, 40),
  maxNumberOfEventsPerStage = c(NA_real_, 60),
  conditionalPower = 0.8,
  maxNumberOfIterations = 5000,
  seed = 12345
)

summary(simulationResults)
```

*Simulation of a survival endpoint (multi-arm design)*

Sequential analysis with a maximum of 2 looks (inverse normal
combination test design), overall significance level 10% (one-sided).
The results were simulated for a multi-arm logrank test (2 treatments
vs. control), H0: hazard ratio(i) = 1, power directed towards smaller
values, H1: omega_max = 0.7, planned cumulative events = c(45, 90),
effect shape = user defined, intersection test = Dunnett, selection =
best, effect measure based on effect estimate, success criterion: all,
sample size reassessment: conditional power = 0.8, minimum events per
stage = c(45, 40), maximum events per stage = c(45, 60), simulation runs
= 5000, seed = 12345.

| Stage                              | 1      | 2      |
|------------------------------------|--------|--------|
| Fixed weight                       | 0.707  | 0.707  |
| Efficacy boundary (z-value scale)  | Inf    | 1.282  |
| Stage levels (one-sided)           | 0      | 0.1000 |
| Futility boundary (z-value scale)  | 0.076  |        |
| Reject at least one                | 0.7830 |        |
| Rejected arms per stage            |        |        |
| Treatment arm vs. control          | 0      | 0.5418 |
| Treatment arm vs. control          | 0      | 0.2412 |
| Success per stage                  | 0      | 0.7830 |
| Exit probability for futility      | 0.0808 |        |
| Expected number of events under H1 | 87.2   |        |
| Overall exit probability           | 0.0808 |        |
| Cumulative number of events        |        |        |
| Treatment arm vs. control          | 31.3   | 70.7   |
| Treatment arm vs. control          | 33.3   | 67.9   |
| Selected arms                      |        |        |
| Treatment arm vs. control          | 1.0000 | 0.6064 |
| Treatment arm vs. control          | 1.0000 | 0.3128 |
| Number of active arms              | 2.000  | 1.000  |
| Conditional power (achieved)       |        | 0.8217 |

Legend:

- *(i)*: treatment arm i

## intersectionTest = “Hierarchical” & hazardRatios \<- c(0.6, 0.7)

``` r
design <- getDesignInverseNormal(
  kMax = 2, 
  alpha = 0.1,
  beta = 0.2,
  typeOfDesign = "noEarlyEfficacy",
  typeBetaSpending = "bsUser",
  userBetaSpending = c(0.059, 0.198) # rho = 1.75
  )

hazardRatios <- c(0.6, 0.7)
effectMatrix <- matrix(hazardRatios, ncol = 2, byrow = TRUE)
plannedEvents <- c(45, 90)

simulationResults <- getSimulationMultiArmSurvival(
  design = design,
  activeArms = 2,
  effectMatrix = effectMatrix,
  typeOfShape = "userDefined", # effect matrix
  intersectionTest = "Hierarchical",
  # intersectionTest = "Dunnett",
  directionUpper = FALSE,
  typeOfSelection = "best",
  plannedEvents = plannedEvents,
  allocationRatioPlanned = 1,
  minNumberOfEventsPerStage = c(NA_real_, 40),
  maxNumberOfEventsPerStage = c(NA_real_, 60),
  conditionalPower = 0.8,
  maxNumberOfIterations = 5000,
  seed = 12345
)

summary(simulationResults)
```

*Simulation of a survival endpoint (multi-arm design)*

Sequential analysis with a maximum of 2 looks (inverse normal
combination test design), overall significance level 10% (one-sided).
The results were simulated for a multi-arm logrank test (2 treatments
vs. control), H0: hazard ratio(i) = 1, power directed towards smaller
values, H1: omega_max = 0.7, planned cumulative events = c(45, 90),
effect shape = user defined, intersection test = Hierarchical, selection
= best, effect measure based on effect estimate, success criterion: all,
sample size reassessment: conditional power = 0.8, minimum events per
stage = c(45, 40), maximum events per stage = c(45, 60), simulation runs
= 5000, seed = 12345.

| Stage                              | 1      | 2      |
|------------------------------------|--------|--------|
| Fixed weight                       | 0.707  | 0.707  |
| Efficacy boundary (z-value scale)  | Inf    | 1.282  |
| Stage levels (one-sided)           | 0      | 0.1000 |
| Futility boundary (z-value scale)  | -0.018 |        |
| Reject at least one                | 0.5892 |        |
| Rejected arms per stage            |        |        |
| Treatment arm vs. control          | 0      | 0.5892 |
| Treatment arm vs. control          | 0      | 0      |
| Success per stage                  | 0      | 0.5892 |
| Exit probability for futility      | 0.0748 |        |
| Expected number of events under H1 | 87.8   |        |
| Overall exit probability           | 0.0748 |        |
| Cumulative number of events        |        |        |
| Treatment arm vs. control          | 31.3   | 71.7   |
| Treatment arm vs. control          | 33.3   | 67.5   |
| Selected arms                      |        |        |
| Treatment arm vs. control          | 1.0000 | 0.6386 |
| Treatment arm vs. control          | 1.0000 | 0.2866 |
| Number of active arms              | 2.000  | 1.000  |
| Conditional power (achieved)       |        | 0.7978 |

Legend:

- *(i)*: treatment arm i

## intersectionTest = “Hierarchical” & hazardRatios \<- c(0.7, 0.6)

``` r
design <- getDesignInverseNormal(
  kMax = 2, 
  alpha = 0.1,
  beta = 0.2,
  typeOfDesign = "noEarlyEfficacy",
  typeBetaSpending = "bsUser",
  userBetaSpending = c(0.059, 0.198) # rho = 1.75
  )

hazardRatios <- c(0.7, 0.6)
effectMatrix <- matrix(hazardRatios, ncol = 2, byrow = TRUE)
plannedEvents <- c(45, 90)

simulationResults <- getSimulationMultiArmSurvival(
  design = design,
  activeArms = 2,
  effectMatrix = effectMatrix,
  typeOfShape = "userDefined", # effect matrix
  intersectionTest = "Hierarchical",
  # intersectionTest = "Dunnett",
  directionUpper = FALSE,
  typeOfSelection = "best",
  plannedEvents = plannedEvents,
  allocationRatioPlanned = 1,
  minNumberOfEventsPerStage = c(NA_real_, 40),
  maxNumberOfEventsPerStage = c(NA_real_, 60),
  conditionalPower = 0.8,
  maxNumberOfIterations = 5000,
  seed = 12345
)

summary(simulationResults)
```

*Simulation of a survival endpoint (multi-arm design)*

Sequential analysis with a maximum of 2 looks (inverse normal
combination test design), overall significance level 10% (one-sided).
The results were simulated for a multi-arm logrank test (2 treatments
vs. control), H0: hazard ratio(i) = 1, power directed towards smaller
values, H1: omega_max = 0.6, planned cumulative events = c(45, 90),
effect shape = user defined, intersection test = Hierarchical, selection
= best, effect measure based on effect estimate, success criterion: all,
sample size reassessment: conditional power = 0.8, minimum events per
stage = c(45, 40), maximum events per stage = c(45, 60), simulation runs
= 5000, seed = 12345.

| Stage                              | 1      | 2      |
|------------------------------------|--------|--------|
| Fixed weight                       | 0.707  | 0.707  |
| Efficacy boundary (z-value scale)  | Inf    | 1.282  |
| Stage levels (one-sided)           | 0      | 0.1000 |
| Futility boundary (z-value scale)  | -0.018 |        |
| Reject at least one                | 0.2658 |        |
| Rejected arms per stage            |        |        |
| Treatment arm vs. control          | 0      | 0.2658 |
| Treatment arm vs. control          | 0      | 0      |
| Success per stage                  | 0      | 0.2658 |
| Exit probability for futility      | 0.1456 |        |
| Expected number of events under H1 | 84.3   |        |
| Overall exit probability           | 0.1456 |        |
| Cumulative number of events        |        |        |
| Treatment arm vs. control          | 33.3   | 68.9   |
| Treatment arm vs. control          | 31.3   | 69.7   |
| Selected arms                      |        |        |
| Treatment arm vs. control          | 1.0000 | 0.3316 |
| Treatment arm vs. control          | 1.0000 | 0.5228 |
| Number of active arms              | 2.000  | 1.000  |
| Conditional power (achieved)       |        | 0.8083 |

Legend:

- *(i)*: treatment arm i
